---
- name: Monthly updates
  cron:
    name: update nextcloud
    state: present
    special_time: monthly
    job: >
      /usr/bin/docker stop {{ container }};
      /usr/bin/docker rm {{ container }};
      /usr/bin/docker pull {{ image }};
      /usr/bin/docker run -d
      --restart unless-stopped
      --name {{ container }}
      --env-file /home/{{ username }}/docker_env_files/nextcloud.env
      -v {{ data_dir }}/data/:/var/www/html/data/
      -v {{ data_dir }}/apps/:/var/www/html/apps/
      -v {{ data_dir }}/config/:/var/www/html/config/
      -p {{ service.cloud.port }}:80
      {{ image }}

- name: Mkdir backup_dir
  file:
    state: directory
    path: "{{ backup_dir }}"
    mode: 0755

- name: Weekly backups
  cron:
    name: "backup cloud"
    state: "present"
    special_time: "weekly"
    job: >
      sudo /bin/cp -urp {{ data_dir }}/* {{ backup_dir }}

- name: Enable auto-refresh with Cron
  cron:
    name: "cloud - cron"
    state: "present"
    minute: "*/5"
    job: >
      /usr/bin/docker exec -u www-data nextcloud /bin/sh -c 'php -f /var/www/html/cron.php'
