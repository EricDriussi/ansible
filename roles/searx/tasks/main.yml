---
- name: SearxNG - Docker
  # TODO.test
  vars: 
    container: "searxng"
    image: "searxng/searxng:latest"
  block:
    - name: Setup docker
      import_role:
        name: common_roles/docker

    - name: Run container
      become_user: "{{ username }}"
      docker_container:
        name: "{{ container }}"
        image: "{{ image }}"
        pull: true
        detach: true
        state: "started"
        restart_policy: unless-stopped
        env:
          INSTANCE_NAME: "SearX!"
        volumes:
          - "/home/{{ username }}/searxng:/etc/searxng"
        ports:
          - "{{ service.searx.port }}:8080"

    - name: Monthly updates
      become_user: "{{ username }}"
      cron:
        name: update searx
        state: present
        special_time: monthly
        job: >
          /usr/bin/docker stop {{ container }} &
          /usr/bin/docker rm {{ container }} &
          /usr/bin/docker pull {{ image }} &
          /usr/bin/docker run -d
          --restart unless-stopped
          --name {{ container }}
          -e BASE_URL=false
          -e INSTANCE_NAME=SearX!
          -v /home/{{ username }}/searxng:/etc/searxng
          -p {{ service.searx.port }}:8080
          {{ image }}
