---
- name: Setup docker
  import_role:
    name: common_roles/docker

- name: Run container
  become_user: "{{ username }}"
  docker_container:
    name: "vaultwarden"
    image: "vaultwarden/server:latest"
    pull: true
    detach: true
    state: "started"
    restart_policy: unless-stopped
    env:
      ADMIN_TOKEN: "{{ admin_token }}"
      SIGNUPS_ALLOWED: "{{ allow_signups | default('false') }}"
    volumes:
      - "/vw-data/:/data/"
    ports:
      - "{{ service.vault.port }}:80"

- name: Monthly updates
  become_user: "{{ username }}"
  cron:
    name: update vaultwarden
    state: present
    special_time: monthly
    job: >
      /usr/bin/docker stop vaultwarden &
      /usr/bin/docker rm vaultwarden &
      /usr/bin/docker pull vaultwarden/server:latest &
      /usr/bin/docker run -d
      --restart unless-stopped
      --name vaultwarden
      -e ADMIN_TOKEN={{ admin_token }}
      -e SIGNUPS_ALLOWED={{ allow_signups | default('false') }}
      -v /vw-data/:/data/
      -p {{ service.vault.port }}:80
      vaultwarden/server:latest"

- name: Weekly backups
  cron:
    name: "backup vault"
    state: "present"
    special_time: "weekly"
    job: >
      /bin/mkdir -p {{ service.vault.backup_dir }} &
      /bin/rm -rf {{ service.vault.backup_dir }}/* &
      /bin/cp /vw-data/db.sqlite* {{ service.vault.backup_dir }} &
      chown -R {{ username }}:{{ username }} {{ service.vault.backup_dir }}
